name: FactoryManagement Azure ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹

env:
  AZURE_FUNCTIONAPP_NAME: factorymanagement-functions-dev
  AZURE_FUNCTIONAPP_PACKAGE_PATH: 'backend'
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '18'

jobs:
  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆAzure Functionsï¼‰ã®ãƒ“ãƒ«ãƒ‰ã¨ãƒ‡ãƒ—ãƒ­ã‚¤
  build-and-deploy-backend:
    name: 'Azure Functions ãƒ‡ãƒ—ãƒ­ã‚¤'
    runs-on: ubuntu-latest
    environment: development
    
    steps:
    - name: 'ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
      uses: actions/checkout@v4

    - name: 'Python ${{ env.PYTHON_VERSION }} ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: 'Python ä¾å­˜é–¢ä¿‚ã®è§£æ±ºã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«'
      run: |
        cd ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: 'Azure Functions ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤'
      uses: Azure/functions-action@v1
      with:
        app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
        package: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
        publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
        scm-do-build-during-deployment: true
        enable-oryx-build: true

  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆVue.jsï¼‰ã®ãƒ“ãƒ«ãƒ‰ã¨ãƒ‡ãƒ—ãƒ­ã‚¤
  build-and-deploy-frontend:
    name: 'Vue.js ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ ãƒ‡ãƒ—ãƒ­ã‚¤'
    runs-on: ubuntu-latest
    environment: development
    
    steps:
    - name: 'ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
      uses: actions/checkout@v4
      with:
        submodules: true
        lfs: false

    - name: 'Node.js ${{ env.NODE_VERSION }} ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: 'ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«'
      run: |
        cd frontend
        npm ci

    - name: 'ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ“ãƒ«ãƒ‰'
      run: |
        cd frontend
        npm run build
      env:
        VUE_APP_API_URL: https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api
        VUE_APP_ENVIRONMENT: development

    - name: 'Azure Static Web Apps ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤'
      id: builddeploy
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: "upload"
        app_location: "frontend"
        output_location: "dist"
        skip_deploy_on_missing_secrets: true

  # ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
  integration-tests:
    name: 'ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ'
    runs-on: ubuntu-latest
    needs: [build-and-deploy-backend, build-and-deploy-frontend]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: 'ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
      uses: actions/checkout@v4

    - name: 'Node.js ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: 'API ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯'
      run: |
        echo "API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™..."
        curl -f https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/v1/equipment-status || exit 1
        echo "âœ… API ã¯æ­£å¸¸ã«å¿œç­”ã—ã¦ã„ã¾ã™"

    - name: 'ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å‹•ä½œç¢ºèª'
      run: |
        echo "Static Web App ã®å‹•ä½œç¢ºèªã‚’å®Ÿè¡Œã—ã¾ã™..."
        # ã“ã“ã§å¿…è¦ã«å¿œã˜ã¦E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        echo "âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®åŸºæœ¬å‹•ä½œã‚’ç¢ºèªã—ã¾ã—ãŸ"

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  security-scan:
    name: 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³'
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: 'ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
      uses: actions/checkout@v4

    - name: 'Python ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³'
      run: |
        cd backend
        pip install safety bandit
        safety check -r requirements.txt
        bandit -r . -f json -o bandit-report.json || true

    - name: 'Node.js ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³'
      run: |
        cd frontend
        npm audit --audit-level moderate

    - name: 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰'
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          backend/bandit-report.json
        retention-days: 30

  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
  performance-test:
    name: 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ'
    runs-on: ubuntu-latest
    needs: [build-and-deploy-backend]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: 'ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
      uses: actions/checkout@v4

    - name: 'è² è·ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ'
      run: |
        echo "ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™..."
        # Apache Bench ã«ã‚ˆã‚‹ç°¡å˜ãªè² è·ãƒ†ã‚¹ãƒˆ
        sudo apt-get update
        sudo apt-get install -y apache2-utils
        
        echo "API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ..."
        ab -n 100 -c 10 https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/v1/equipment-status
        
        echo "âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Œäº†"

  # ãƒ‡ãƒ—ãƒ­ã‚¤é€šçŸ¥
  notify:
    name: 'ãƒ‡ãƒ—ãƒ­ã‚¤é€šçŸ¥'
    runs-on: ubuntu-latest
    needs: [build-and-deploy-backend, build-and-deploy-frontend]
    if: always()
    
    steps:
    - name: 'ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã®é€šçŸ¥'
      uses: 8398a7/action-slack@v3
      if: env.SLACK_WEBHOOK_URL != ''
      with:
        status: ${{ job.status }}
        channel: '#factory-management'
        text: |
          FactoryManagement ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ
          
          ğŸ”§ Backend: ${{ needs.build-and-deploy-backend.result }}
          ğŸŒ Frontend: ${{ needs.build-and-deploy-frontend.result }}
          
          ğŸ“Š Function App: https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net
          ğŸ–¥ï¸ Web App: ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}